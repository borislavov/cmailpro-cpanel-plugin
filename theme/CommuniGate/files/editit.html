<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<cpanel setvar="dprefix=../">
<html>
<head>
<title>cPanel X - <cpanel Locale="maketext('File Manager')"></title>
<cpanel relinclude="charset.html">

<link rel="stylesheet" href="../css/combined_optimized.css">
<link rel="stylesheet" href="<cpanel MagicRevision="uri("/frontend/x3/filemanager/css/tree_styles2_optimized.css")>">

<link href="<cpanel Branding="file(local.css,0,0,0,0,1,,1)">" rel="stylesheet" type="text/css">
<script type="text/javascript" src="<cpanel MagicRevision="uri("/yui/utilities_container/utilities_container-full.js")">"></script>
<script type="text/javascript" src="<cpanel MagicRevision="uri("/cjt/cpanel-all.js")">"></script>
<script type="text/javascript" src="../js/filemanager_editors_optimized.js"></script>
<style type="text/css">
html, body, #maintbl {
    height: 100%;
    width: 100%;
    margin: 0;
    padding: 0;
    background: none !important;
}

form { margin: 0 }

#switch_editor_control img {
    vertical-align: middle;
}

#codewindow {
    margin:0;
    width: 100%;
    border:0;
}

#maintbl, #maintbl tr, #maintbl td {
    margin:0;
    padding:0;
    border-collapse: collapse;
    border: none;
}

#maintbl td#codewindow_container {
    padding: 0 0 0 3px;
}

#tcell, #page {
    height: 100%;
    width: 100%;
    margin: 0;
    padding: 0;
    border: 0;
}
#closebutton {
    padding-right: 5px;
    margin-right: 5px;
    margin-top: 10px;
}
#helpDiv {
    margin-bottom: 10px;
}
.cjt_progress_overlay .bd {
    background: transparent;
}

<cpanel Branding="include(sprites.html)">

/* Suppress inherited styles from global style sheets. */
.yui-panel .hd,
.yui-panel .bd,
.yui-panel .ft {
    background-image: none;
    font-size: 100%;
}
textarea {
    font-size: 1.2em;
    font-family: monospace;
}

/* overrides from tree_styles2_optimized.css */
p {
    line-height: normal;
}
.input-button, .input-button:hover {
    height: auto;
}
</style>

<!--[if IE]>
<style type="text/css">
#codewindow {
    width: 99.5%;
}
</style>
<![endif]-->

</head>
<body class="nomargins yui-skin-sam">
<form action="javascript:void(0)" name="sform" onsubmit="loadfdata('sform_submit'); return false;">
<table border="0" id="maintbl" cellpadding="0" cellspacing="0">
<tr style="background-color: #cccccc;">
 <td height="29" style="height: 26px;">
    <div style="float:left; width:70%; padding-left:5px;">
    <label style="font-weight: 900; font-size:13px;"><cpanel langprint="FMEditText">:
    <input style="width:40%;height:24px;" id="path" name="path" value="<cpanel cprint="$FORM{'dir'}">/<cpanel cprint="$FORM{'file'}">"></label>
    <label style="font-weight: 900; font-size:13px;"><cpanel Locale="maketext('Encoding:')">
        <select id="charset" name="charset">
        <cpanelif $FORM{'file_charset'}=et=_DETECT_>
        <?cp Encoding::guess_file_opts([option value="%" %]%[/option],map,selected,map) file=$FORM{'dir'}/$FORM{'file'} ?>
        <cpanelelse>
        <?cp Encoding::guess_file_opts([option value="%" %]%[/option],map,selected,map) file=$FORM{'dir'}/$FORM{'file'},file_charset=$FORM{'file_charset'} ?>
        </cpanelif>
        </select>
    </label>
    <input type="button" onclick="loadfile(this);" class="input-button" value="<cptext "Re-open">">
    </div>
    <div style="float:right;padding-right:5px">
        <button type="button" class="input-button" id="switch_editor_control" onclick="try {toggle_EditArea(this)} catch(e) {} return false">
<cpanelif $FORM{'codeedit'}>
<img width="16" src="<cpanel MagicRevision="uri(filemanager/img/icons/Document 2 Edit 2.gif)">" />
<cptext "Use text editor">
<cpanelelse>
<img width="16" src="<cpanel MagicRevision="uri(filemanager/img/icons/codeEditorB.gif)">" />
<cptext "Use code editor">
</cpanelif>
        </button>
        &nbsp;
        <input type="button" onclick="confirm_close(this);" class="input-button" value="<cpanel langprint="Close">" />
        <button type="submit" id="sform_submit" class="input-button" style="font-weight:bold"><cpanel langprint="SaveChanges"></button>
    </div>
 </td>
</tr>
<tr>
 <td id="codewindow_container">
    <textarea id="codewindow"
class="codepress <?cp Fileman::getedittype(%,type) dir=$FORM{'dir'},file=$FORM{'file'} ?>"
<cpanelif $FORM{'codeedit'}>
style="visibility:hidden"
</cpanelif>
    wrap="virtual" name="page"><cpanel Fileman="fmpushfile($FORM{'dir'},$FORM{'file'},$FORM{'file_charset'})"></textarea>
 </td>
</tr>
</table>
</form>

<script type="text/plain" id="general_encoding_changed_template">
<p><cptext 'The system was unable to save your document in [_1] encoding. Most likely, your document contains characters incompatible with [_1].',{old_charset}></p>

<p><cptext 'cPanel has upgraded your document to [_1] encoding. Please verify that the file opens correctly in your application.',{new_charset}></p>

<p><cptext 'To learn more about file encoding, visit [output,url,_1,_1]',http://go.cpanel.net/encoding></p>
</script>

<?cptt _ajaxapp.tmpl ?>
<script type="text/javascript">
var CHARSET = document.sform.charset.value;

if ( !window.LOCALE ) LOCALE = {};
LOCALE.charset_changed = "<cptext 'Character encoding change'>";
LOCALE.confirm_close   = "<cptext 'You have unsaved changes. Are you sure you want to close this window?'>";
LOCALE.reloading       = "<cptext 'Reloading…'>";

function loadfile(clicked_el) {
    var textarea = DOM.get("codewindow");
    if (textarea.value !== textarea.defaultValue) {
        var sure = confirm("<cpanel Locale="maketext('Are you sure you wish to open a new file? You will lose any changes you have made.')">");
        if (!sure) { return; }
    }
    var filen = document.sform.path.value;
    var fpath = filen.split('/');;
    var filename = fpath.pop();
    var dir = fpath.join('/');
    var sdir = encodeURIComponent(dir);
    var sfilename = encodeURIComponent(filename);
    var charset = document.getElementById('charset').value;

    var pp = new CPANEL.ajax.Progress_Panel( DOM.generateId(), {
        status_html : "<cptext "Reloading…">",
        effect: CPANEL.ajax.FADE_MODAL
    } );
    if (clicked_el) {
        pp.show_from_source(clicked_el);
    }
    else {
        pp.show();
    }

    document.location.href="?dir=" + sdir + "&file=" + sfilename + '&file_charset=' + charset;
}

var LAST_NOTICE = null;

function loadfdata(clicked_el) {
    var path     = DOM.get("path");

    if ( CODEWINDOW.value === CODEWINDOW.defaultValue && path.value === path.defaultValue ) {
        LAST_NOTICE = new CPANEL.ajax.DynamicNotice({content:"<cptext "You have made no changes to save.">", level:"info", replaces:LAST_NOTICE});
        return;
    }

    var match = path.value.match(/^(.+)\/([^\/]+)$/);
    if ( !match ) {
        LAST_NOTICE = new CPANEL.ajax.DynamicNotice({content:"<cptext "Invalid path.">", level:"error", replaces:LAST_NOTICE});
        return;
    }

    var pp = new CPANEL.ajax.Progress_Panel( DOM.generateId(), {
        zIndex:      2500,
        show_status: true,
        status_html: "<cptext 'Saving “[_1]”…',{the_file}>".replace('{the_file}',match[2]),
        success_notice_options: { replaces:LAST_NOTICE },
    } );
    pp.show_from_source(clicked_el);

    var callback_opts = {};

    var callback = CPANEL.ajax.build_callback(
        function(result) {
            var no_change = check_for_encoding_change.call(
                pp,
                CPANEL.ajax.templates.general_encoding_changed_template,
                result
            );

            if ( no_change === false ) {
                callback_opts.keep_current_on_success = true;
            }
            else {
                CODEWINDOW.defaultValue = CODEWINDOW.value;
                LAST_NOTICE = new CPANEL.ajax.DynamicNotice( {level:"success", content:CPANEL.LANG.success, replaces:LAST_NOTICE} );
            }
        },
        { current:pp },
        callback_opts
    );

    var api_params = {
        module:   "Fileman",
        func:     "savefile",
        data:     {
            dir:           match[1],
            filename:      match[2],
            content:       window.editAreaLoader ? editAreaLoader.getValue("codewindow") : document.sform.page.value,
            utf8_fallback: 1,
            charset:       CHARSET
        },
        callback: callback
    };

    var req = CPANEL.api( api_params );

    return false;
}
</script>

<script type="text/javascript" src="<cpanel MagicRevision="uri("/editarea/edit_area/edit_area_full.js")">"></script>
<script type="text/javascript" src="<cpanel MagicRevision="uri("js/edit_area_resizer.js")">"></script>
<script>
var editAreaEl='codewindow';
var lastResizeTime=0;
var lastResizeRequestTime=0;

function unhide_codewindow() {
    DOM.setStyle("codewindow","visibility","");
    if ( YAHOO.env.ua.ie ) fix_ie_margin();
    set_link_for_code();
};

var EditArea_config = {
<cpanelif $FORM{'codeedit'}>
    EA_load_callback: "unhide_codewindow",
<cpanelelse>
    display: "later",
    EA_load_callback: "set_link_for_code",
</cpanelif>
    EA_toggle_on_callback: "set_link_for_code",
    EA_toggle_off_callback: "set_link_for_text",
    id: editAreaEl,
    start_highlight: true,
    allow_resize: "both",
    allow_toggle: false,
    language: "en",
    toolbar: "search, go_to_line, |, undo, redo, |, select_font, |, syntax_selection, |, change_smooth_selection, highlight, reset_highlight, |, help",
    syntax: "<?cp Fileman::getedittype(%,type) editor=editarea,dir=$FORM{'dir'},file=$FORM{'file'} ?>"
};

function load_EditArea() {
    //Set the code textarea width to 800px temporarily
    //so EditArea will size the edit area to that width.
    //This mimicks behavior of the old separate editit_code.html.
    if ( !CODEWINDOW) CODEWINDOW = DOM.get(editAreaEl);
    CODEWINDOW.style.visibility = "";
    CODEWINDOW.style.width = "800px";

    editAreaLoader.init(EditArea_config);

<cpanelif $FORM{'codeedit'}>
    doResizeSoon();
<cpanelelse>
    textarea_sizer();
</cpanelif>
}

function fix_ie_margin() {
    //work around a bug in EditArea that sets a marginTop when it shouldn't.
    //The EA code has an exception for IE>7, but it kills detecting IE>7 early
    //on presuming that it will be able to force IE7 compatibility mode.
    //(Which it can't always do, actually.)
    if ( YAHOO.env.ua.ie > 7 ) {
        var iframe_window = DOM.get("frame_codewindow");
        iframe_window.contentDocument.getElementById("textarea").style.marginTop = "";
    }
}

function set_link_for_code() {
    DOM.get("switch_editor_control").innerHTML = "<img width=\"16\" src=\""+editor_icons.text+"\" /> <cptext "Use text editor">";
    if ( YAHOO.env.ua.ie ) fix_ie_margin();
    window.ea_shown = true;
}
function set_link_for_text() {
    DOM.get("switch_editor_control").innerHTML = "<img width=\"16\" src=\""+editor_icons.code+"\" /> <cptext "Use code editor">";
}

function toggle_EditArea(link) {
    var ea = editAreas[editAreaEl];

    if (!ea || !ea.displayed) {
<cpanelif !$FORM{'codeedit'}>
        if ( !window.ea_shown ) {
            CODEWINDOW.style.visibility = "";
            CODEWINDOW.style.width = "800px";
        }
</cpanelif>
        editAreaLoader.toggle_on(editAreaEl);
        doResizeSoon();
        EVENT.removeListener( window, "resize", textarea_sizer );
        EVENT.addListener( window, "resize", doResizeSoon );
    }
    else {
        editAreaLoader.toggle_off(editAreaEl);
        EVENT.removeListener( window, "resize", doResizeSoon );
        EVENT.addListener( window, "resize", textarea_sizer );
        textarea_sizer();
    }
}

var CODEWINDOW;
var codewindow_padding = YAHOO.env.ua.ie ? 3 : 0;
function textarea_sizer() {
    var pos = DOM.getXY(CODEWINDOW);
    var viewport_height = DOM.getViewportHeight();
    var viewport_width  = DOM.getViewportWidth();
    CODEWINDOW.style.width  = (viewport_width  - pos[0] - codewindow_padding) + "px";
    CODEWINDOW.style.height = (viewport_height - pos[1] - codewindow_padding) + "px";
}

var editor_icons = {
    code: "<cpanel MagicRevision="uri(filemanager/img/icons/codeEditorB.gif)">",
    text: "<cpanel MagicRevision="uri(filemanager/img/icons/Document 2 Edit 2.gif)">"
};

EVENT.throwErrors = true;
EVENT.onDOMReady( function() {
    CODEWINDOW = DOM.get(editAreaEl);
    var img = document.createElement("img");
    img.style.display = "none";
<cpanelif $FORM{'codeedit'}>
    img.src = editor_icons.code;
    EVENT.addListener(window, "resize", doResizeSoon);
<cpanelelse>
    img.src = editor_icons.text;
    EVENT.addListener( window, "resize", textarea_sizer );
</cpanelif>
    document.body.appendChild(img);
} );

YAHOO.util.Event.addListener(window, "load", load_EditArea);
//YAHOO.util.Event.addListener(window, "load", textarea_sizer);
</script>

</body>
</html>
